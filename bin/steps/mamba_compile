#!/usr/bin/env bash
set +e

MICROMAMBA_VERSION=$(cat mamba.yml | grep 'runtime:'| tr -d "\n")

IFS=' ' read -r -a RUNTIME_ARRAY <<< ${MICROMAMBA_VERSION}
# https://anaconda.org/conda-forge/micromamba/0.23.1/download/linux-64/micromamba-0.23.1-0.tar.bz2
MICROMAMBA_URL=${RUNTIME_ARRAY[-1]}


IFS='/' read -r -a URL_PARTS <<< ${MICROMAMBA_URL}
# micromamba-0.23.1-0.tar.bz2
MICROMAMBA_FILENAME=${URL_PARTS[-1]}

IFS='-' read -r -a VERSION_ARRAY <<< ${MICROMAMBA_FILENAME}
# 0.23.1
VERSION=${VERSION_ARRAY[1]}

MICROMAMBA_VERBOSITY=-v


if [ ! -d /app/.heroku/micromamba ]; then
    puts-step "Fetching Mamba from: ${MICROMAMBA_URL}"
    if ! curl -Ofv $MICROMAMBA_URL ; then
        exit 1
    fi

    ls ./
    puts-step "Extracting: ${MICROMAMBA_FILENAME}"
    mkdir -p /app/.heroku/micromamba/
    tar -xvjf $MICROMAMBA_FILENAME -C /app/.heroku/micromamba/ | indent
    rm $MICROMAMBA_FILENAME

    ls /app/.heroku/micromamba/

    if [ -f .condarc ]; then
        puts-step "Copying condarc file to micromamba directory"
        cp .condarc /app/.heroku/micromamba
    fi

    micromamba config --set auto_update_conda False
    micromamba install $MICROMAMBA_VERBOSITY pip --yes | indent
fi

mkdir -p $HOME/.heroku/micromamba/mamba-meta/
echo "nomkl" > $HOME/.heroku/micromamba/mamba-meta/pinned
# Pin the conda version if proper version, not `latest` or anything else
if [[ $VERSION =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
	echo "micromamba ==${VERSION}" >> $HOME/.heroku/micromamba/mamba-meta/pinned
fi
echo "added pinned file in $HOME/.heroku/micromamba/mamba-meta/pinned"

# Update the root conda env with the mamba.yml instead of creating
# a new env
puts-step "Updating mamba environment"
micromamba env update $MICROMAMBA_VERBOSITY --name root --file mamba.yml | indent

if [ -f requirements.txt ]; then
    puts-step "Installing dependencies using Pip"
    pip install -r requirements.txt  --exists-action=w | indent
fi

# Clean up the installation environment .
conda clean -pt --yes > /dev/null
